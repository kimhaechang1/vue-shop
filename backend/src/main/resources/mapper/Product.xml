<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.khc.shop.product.model.mapper.ProductMapper">
    <resultMap id="product" type="productDto">
        <result column="product_id" property="productId"></result>
        <result column="product_name" property="productName"></result>
        <result column="product_img" property="productImg"></result>
        <result column="product_brand" property="productBrand"></result>
        <result column="product_description" property="productDescription"></result>
    </resultMap>

    <resultMap id="productWH" type="productWHDto">
        <result column="product_id" property="productId"></result>
        <result column="product_code" property="productCode"></result>
        <result column="product_size" property="productSize"></result>
        <result column="product_date" property="productDate"></result>
    </resultMap>

    <resultMap id="productInfo" type="productInfoDto">
        <result column="product_id" property="productId"></result>
        <result column="product_name" property="productName"></result>
        <result column="product_img" property="productImg"></result>
        <result column="product_brand" property="productBrand"></result>
        <result column="product_description" property="productDescription"></result>
        <result column="product_code" property="productCode"></result>
        <result column="product_size" property="productSize"></result>
        <result column="product_date" property="productDate"></result>
    </resultMap>

    <sql id="searchProduct">
        <if test='brand != null and !"".equals(brand)'>
            AND product_brand LIKE CONCAT('%','${brand}','%')
        </if>
        <if test='word!=null and !"".equals(word)'>
            AND product_name LIKE CONCAT('%','${word}','%')
        </if>
    </sql>

    <sql id="searchProductItem">
        <if test='size!=null and !"".equals(size)'>
            AND product_size = ${size}
        </if>
    </sql>

    <sql id="limit">
        <if test='start != null and !"".equals(start) and offset != null and !"".equals(offset)'>
            LIMIT ${start}, ${offset}
        </if>
    </sql>

    <select id="getProductList" parameterType="map" resultMap="product">
        SELECT
            product_id, product_name, product_img, product_brand, product_description
        FROM product
        WHERE 1 = 1
        <include refid="searchProduct"></include>
        <include refid="limit"></include>
    </select>
    <select id="getProductCount" parameterType="map" resultType="int">
        SELECT
            COUNT(product_id)
        FROM product
        WHERE 1=1
        <include refid="searchProduct"></include>
    </select>

    <insert id="insertProduct" parameterType="productDto">
        INSERT INTO product
            (product_name, product_img, product_brand, product_description)
        VALUES ('${productName}', '${productImg}', '${productBrand}', '${productDescription}')
        <selectKey keyProperty="productId" resultType="int" order="AFTER">
            select last_insert_id()
        </selectKey>
    </insert>

    <insert id="insertProductItem" parameterType="productWHDto">
        INSERT INTO product_warehouse
            (product_code, product_id, product_size)
        VALUES ('${productCode}', ${productId}, ${productSize})
    </insert>

    <select id="getProductWHCountByProductId" parameterType="map" resultType="int">
        SELECT COUNT(product_code)
        FROM product_warehouse
        WHERE product_id = ${productId}
        <include refid="searchProductItem"></include>
    </select>

    <select id="getProductWHListByProductId" parameterType="map" resultMap="productWH">
        SELECT product_code, product_id, product_size, product_date
        FROM product_warehouse
        WHERE product_id = ${productId}
        <include refid="searchProductItem"></include>
    </select>

    <select id="getProductIdbyProductName" parameterType="String" resultType="java.lang.Integer">
        SELECT product_id
        FROM product
        WHERE product_name = '${productName}'
    </select>

    <select id="searchProductByCode" parameterType="String" resultMap="productInfo">
        SELECT
            p.product_id, p.product_name, p.product_img, p.product_brand, p.product_description, d.product_code, d.product_size, d.product_date
        FROM product_warehouse d inner join product p
        on d.product_id = p.product_id
        where product_code = '${productCode}'
    </select>
</mapper>
